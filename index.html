<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Tara's Dashboard</title>
  <style>
    *{box-sizing:border-box}
    body{
      font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;
      margin:0;
      background:#fafbfc;
      min-height:100vh;color:#1a1a1a
    }
    header{
      background:linear-gradient(135deg,#4a6741 0%,#5a7c50 100%);
      color:#fff;padding:24px 32px;box-shadow:0 4px 20px rgba(74,103,65,.15);
      position:relative;overflow:hidden
    }
    header::before{
      content:'';position:absolute;inset:0;
      background:url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grid" width="10" height="10" patternUnits="userSpaceOnUse"><path d="M 10 0 L 0 0 0 10" fill="none" stroke="rgba(255,255,255,0.05)" stroke-width="0.5"/></pattern></defs><rect width="100" height="100" fill="url(%23grid)"/></svg>')
    }
    .header-content{position:relative;z-index:1}
    .header-title{margin:0;font-size:28px;font-weight:600;letter-spacing:-.02em}
    .header-subtitle{color:rgba(255,255,255,.8);font-size:14px;margin:4px 0 0 0;font-weight:400}

    /* Navigation Bar */
    .nav-bar{
      background:#fff;
      border-bottom:1px solid #e0e0e0;
      box-shadow:0 2px 8px rgba(0,0,0,.05)
    }
    .nav-content{
      max-width:1200px;
      margin:0 auto;
      display:flex;
      gap:0;
      padding:0
    }
    .nav-item{
      padding:14px 24px;
      color:#333;
      text-decoration:none;
      font-weight:500;
      font-size:14px;
      border-bottom:3px solid transparent;
      transition:.2s;
      cursor:pointer;
      background:none;
      border-left:none;
      border-right:none;
      border-top:none;
    }
    .nav-item:hover{
      color:#4a6741;
      background:rgba(139,195,74,.08)
    }
    .nav-item.active{
      color:#4a6741;
      border-bottom-color:#4a6741;
      font-weight:600
    }

    /* Client Filter Cards */
    .client-cards-section{
      background:#fff;margin:20px auto;max-width:1200px;border-radius:16px;
      box-shadow:0 2px 12px rgba(0,0,0,.06);border:1px solid rgba(139,195,74,.12);overflow:hidden;padding:24px
    }
    .client-cards-container{
      display:grid;grid-template-columns:repeat(6,1fr);gap:16px
    }
    /* Category Cards (Top News & Newsletters) */
    .category-cards-section{
      background:#fff;margin:20px auto;max-width:600px;border-radius:16px;
      box-shadow:0 2px 12px rgba(0,0,0,.06);border:1px solid rgba(139,195,74,.12);overflow:hidden;padding:24px
    }
    .category-cards-container{
      display:grid;grid-template-columns:repeat(2,1fr);gap:16px
    }
    .category-card{
      background:linear-gradient(135deg,#fff,#fafbfc);
      border-radius:12px;padding:24px;
      box-shadow:0 2px 8px rgba(0,0,0,.05);
      border:2px solid rgba(139,195,74,.12);
      transition:.3s;cursor:pointer;
      text-align:center;
      position:relative;
      overflow:hidden
    }
    .category-card::before{
      content:'';position:absolute;top:0;left:0;right:0;height:3px;
      background:linear-gradient(90deg,#8bc34a,#7cb342);
      opacity:0;transition:.3s
    }
    .category-card:hover{
      transform:translateY(-4px);
      box-shadow:0 8px 20px rgba(0,0,0,.12);
      border-color:rgba(139,195,74,.4)
    }
    .category-card:hover::before{opacity:1}
    .category-card.active{
      border:2px solid #4a6741;
      background:linear-gradient(135deg,rgba(139,195,74,.08),rgba(139,195,74,.12));
      box-shadow:0 4px 16px rgba(74,103,65,.2)
    }
    .category-card.active::before{opacity:1}
    .category-card-name{
      font-size:15px;font-weight:600;color:#333;
      margin-bottom:8px;letter-spacing:-.01em
    }
    .category-card-count{
      font-size:24px;font-weight:700;color:#4a6741;
      margin-top:4px
    }
    .client-card{
      background:linear-gradient(135deg,#fff,#fafbfc);
      border-radius:12px;padding:24px;
      box-shadow:0 2px 8px rgba(0,0,0,.05);
      border:2px solid rgba(139,195,74,.12);
      transition:.3s;cursor:pointer;
      text-align:center;
      position:relative;
      overflow:hidden
    }
    .client-card::before{
      content:'';position:absolute;top:0;left:0;right:0;height:3px;
      background:linear-gradient(90deg,#8bc34a,#7cb342);
      opacity:0;transition:.3s
    }
    .client-card:hover{
      transform:translateY(-4px);
      box-shadow:0 8px 20px rgba(0,0,0,.12);
      border-color:rgba(139,195,74,.4)
    }
    .client-card:hover::before{opacity:1}
    .client-card.active{
      border:2px solid #4a6741;
      background:linear-gradient(135deg,rgba(139,195,74,.08),rgba(139,195,74,.12));
      box-shadow:0 4px 16px rgba(74,103,65,.2)
    }
    .client-card.active::before{opacity:1}
    .client-card-name{
      font-size:15px;font-weight:600;color:#333;
      margin-bottom:8px;letter-spacing:-.01em
    }
    .client-card-count{
      font-size:24px;font-weight:700;color:#4a6741;
      margin-top:4px
    }

    .wrap{max-width:1200px;margin:0 auto;padding:24px 24px}

    /* Filter Bar */
    .filter-bar{
      display:flex;
      gap:12px;
      align-items:center;
      margin:16px 0;
      padding:16px;
      background:#fff;
      border-radius:12px;
      box-shadow:0 2px 8px rgba(0,0,0,.05);
      border:1px solid rgba(139,195,74,.12);
      flex-wrap:wrap
    }
    .filter-section{
      display:flex;
      gap:8px;
      align-items:center
    }
    .filter-divider{
      width:1px;
      height:24px;
      background:#e0e0e0;
      margin:0 8px
    }
    input,select{padding:9px 12px;border-radius:8px;border:1px solid #d9e1ec;font-size:14px}
    input[type="date"]{padding:8px 12px}
    .date-preset-btn{
      background:#f5f5f5;
      border:1px solid #d9e1ec;
      padding:6px 12px;
      border-radius:6px;
      font-size:13px;
      cursor:pointer;
      transition:.2s;
      font-weight:500;
      color:#333
    }
    .date-preset-btn:hover{background:#e8f5e9}
    .date-preset-btn.active{background:#4a6741;color:#fff;border-color:#4a6741}
    .section-title{font-size:19px;font-weight:700;color:#1a1a1a;margin:16px 0 12px 0;display:flex;align-items:center;gap:12px;letter-spacing:-.01em}
    .section-title::before{content:'';width:4px;height:20px;background:linear-gradient(135deg,#8bc34a,#7cb342);border-radius:2px}
    .articles-container{display:grid;gap:16px}
    .card{background:#fff;border-radius:12px;box-shadow:0 2px 12px rgba(0,0,0,.06);padding:0;border:1px solid rgba(139,195,74,.12);transition:.3s;position:relative;overflow:hidden;opacity:0;transform:translateY(20px);animation:slideIn .5s ease forwards}
    @keyframes slideIn{to{opacity:1;transform:translateY(0)}}
    .card::before{content:'';position:absolute;top:0;left:0;width:100%;height:4px;background:linear-gradient(90deg,#8bc34a,#7cb342)}
    .card:hover{transform:translateY(-3px);box-shadow:0 8px 24px rgba(0,0,0,.1);border-color:rgba(139,195,74,.25)}
    .card-content{padding:20px}
    .card-title{font-size:17px;font-weight:600;color:#1a1a1a;margin:0 0 10px 0;line-height:1.4;letter-spacing:-.01em}
    .card-title a{color:inherit;text-decoration:none;transition:.3s}
    .card-title a:hover{color:#4a6741}
    .meta{color:#666;font-size:13px;margin-bottom:12px;display:flex;align-items:center;gap:12px;flex-wrap:wrap}
    .chip{background:linear-gradient(135deg,rgba(139,195,74,.12),rgba(139,195,74,.18));border:1px solid rgba(139,195,74,.25);border-radius:12px;padding:5px 11px;margin:4px 6px 4px 0;font-size:12px;font-weight:500;display:inline-block;color:#4a6741;transition:.3s}
    .chip:hover{background:linear-gradient(135deg,rgba(139,195,74,.18),rgba(139,195,74,.25));transform:scale(1.05)}
    .chip-container{margin-top:12px;padding-top:12px;border-top:1px solid rgba(139,195,74,.15)}
    .article-summary{color:#666;font-size:13px;line-height:1.5;margin-top:10px;padding-top:10px;border-top:1px solid rgba(139,195,74,.15)}

    .loading{display:flex;align-items:center;justify-content:center;padding:40px;color:#666}
    .loading::before{content:'';width:20px;height:20px;border:2px solid rgba(139,195,74,.3);border-top:2px solid #8bc34a;border-radius:50%;animation:spin 1s linear infinite;margin-right:12px}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    #err{background:linear-gradient(135deg,#ffebee,#fce4ec);border:1px solid #ffcdd2;color:#d32f2f;padding:16px 20px;border-radius:12px;margin:16px 0;font-weight:500;display:none}
    .empty-state{text-align:center;padding:60px 20px;color:#666;background:#fff;border-radius:16px;border:1px solid rgba(139,195,74,.12)}
    .empty-state-icon{font-size:48px;margin-bottom:16px;opacity:.5}
    .action-btn{background:#1b5e20;color:#fff;border:none;padding:9px 18px;border-radius:8px;font-weight:600;cursor:pointer;transition:.3s;font-size:13px}
    .action-btn:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(74,103,65,.3)}
    .action-btn:disabled{opacity:.6;cursor:not-allowed;transform:none}
    .action-btn.secondary{background:#4a6741}
    .action-btn.secondary:hover{background:#5a7c50}
    .card-loading{background:#fff;border-radius:16px;padding:20px;margin:16px 0;border:1px solid rgba(139,195,74,.12);animation:pulse 1.5s ease-in-out infinite}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.7}}
    .skeleton{background:linear-gradient(90deg,#f0f0f0 25%,#e0e0e0 50%,#f0f0f0 75%);background-size:200% 100%;animation:loading 1.5s infinite;border-radius:4px}
    @keyframes loading{0%{background-position:200% 0}100%{background-position:-200% 0}}
    .skeleton-title{height:20px;margin-bottom:12px;width:75%}
    .skeleton-meta{height:14px;margin-bottom:8px;width:40%}
    .skeleton-chip{height:24px;width:60px;display:inline-block;margin-right:8px}
    @media (max-width:768px){
      .wrap{padding:20px 16px}
      .meta{flex-direction:column;align-items:flex-start;gap:8px}
      .summary-grid{grid-template-columns:repeat(2,1fr)}
      .nav-content{flex-wrap:wrap}
      .filter-bar{padding:12px}
    }

    /* Chat Interface */
    .chat-container{background:#fff;border-radius:12px;box-shadow:0 2px 12px rgba(0,0,0,.06);border:1px solid rgba(139,195,74,.12);padding:20px;margin-bottom:20px}
    .chat-header{font-size:17px;font-weight:700;color:#1a1a1a;margin-bottom:16px;display:flex;align-items:center;gap:8px;letter-spacing:-.01em}
    .chat-input{width:100%;padding:12px;border:1px solid rgba(139,195,74,.25);border-radius:8px;font-size:14px;resize:vertical;min-height:60px}
    .chat-button{background:#4a6741;color:#fff;border:none;padding:10px 20px;border-radius:8px;font-weight:600;cursor:pointer;transition:.3s;margin-top:8px;font-size:13px}
    .chat-button:hover{background:#5a7c50;transform:translateY(-1px)}
    .chat-button:disabled{opacity:.6;cursor:not-allowed}
    .chat-response{background:rgba(139,195,74,.08);border-left:4px solid #4a6741;padding:16px;border-radius:8px;margin-top:16px;line-height:1.6;display:none}
    .chat-loading{display:none;align-items:center;gap:8px;color:#666;margin-top:12px}

    /* Article Flag Checkbox */
    .flag-checkbox{
      width:18px;
      height:18px;
      cursor:pointer;
      accent-color:#4a6741;
      border:2px solid #4a6741;
      margin-right:12px;
      vertical-align:middle;
      flex-shrink:0;
    }
    .flag-checkbox:checked{
      background:#4a6741;
    }
/* Base chip style */
.chip{
  background:linear-gradient(135deg,rgba(139,195,74,.12),rgba(139,195,74,.18));
  border:1px solid rgba(139,195,74,.25);
  border-radius:12px;
  padding:5px 11px;
  margin:4px 6px 4px 0;
  font-size:12px;
  font-weight:500;
  display:inline-block;
  color:#4a6741;
  transition:.3s;
}

/* Sentiment variants */
.chip--pos{
  background:linear-gradient(135deg,rgba(76,175,80,.15),rgba(76,175,80,.25));
  border:1px solid rgba(76,175,80,.35);
  color:#1b5e20;
}
.chip--neg{
  background:linear-gradient(135deg,rgba(244,67,54,.15),rgba(244,67,54,.25));
  border:1px solid rgba(244,67,54,.35);
  color:#b71c1c;
}
.chip--neu{
  background:linear-gradient(135deg,rgba(158,158,158,.15),rgba(158,158,158,.25));
  border:1px solid rgba(158,158,158,.35);
  color:#424242;
}
    /* --- Spikes UI --- */
.spike-section{background:#fff;margin:20px auto;max-width:1200px;border-radius:16px;box-shadow:0 2px 12px rgba(0,0,0,.06);border:1px solid rgba(255,193,7,.25);padding:20px}
.spike-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:14px;margin-top:10px}
.spike-card{background:linear-gradient(135deg,#fff7e6,#fff0c2);border:1px solid #ffc107;border-radius:12px;padding:14px}
.spike-hdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
.spike-platform{background:rgba(230,126,34,.12);color:#a05a11;padding:4px 8px;border-radius:6px;font-size:12px;font-weight:600}
.spike-pct{font-size:20px;font-weight:800;color:#a05a11}
.spike-title{margin:0 0 6px 0;font-size:14px;font-weight:600;color:#1a1a1a}
.spike-meta{margin:0;font-size:12px;color:#555}
  </style>
</head>
<body>

  <!-- Header -->
  <header style="background:#4a6741">
    <div style="max-width:1200px;margin:0 auto;padding:20px 32px;display:flex;justify-content:space-between;align-items:center">
      <div>
        <h1 style="margin:0;font-size:32px;font-weight:700;color:#fff;letter-spacing:-.02em">Tara's Dashboard</h1>
      </div>
      <div style="text-align:right">
        <div style="font-size:11px;color:rgba(255,255,255,.7);text-transform:uppercase;letter-spacing:.5px;margin-bottom:2px">Last Update</div>
        <div id="header-last-updated" style="font-size:18px;font-weight:700;color:#8bc34a">â€”</div>
      </div>
    </div>
  </header>


  <!-- Client Filter Cards (Alphabetical) -->
  <div class="client-cards-section">
    <div style="text-align:center;margin-bottom:16px;color:#666;font-size:13px;font-weight:500">
      <span id="date-range-label">Last 7 Days</span>
    </div>
    <div class="client-cards-container">
      <div class="client-card" data-client="delta_air_lines_rss" onclick="filterByClient('delta_air_lines_rss')">
        <div class="client-card-name">Delta Air Lines</div>
        <div class="client-card-count" id="client-delta">â€”</div>
      </div>
      <div class="client-card" data-client="google_rss" onclick="filterByClient('google_rss')">
        <div class="client-card-name">Google</div>
        <div class="client-card-count" id="client-google">â€”</div>
      </div>
      <div class="client-card" data-client="stubhub_rss" onclick="filterByClient('stubhub_rss')">
        <div class="client-card-name">StubHub</div>
        <div class="client-card-count" id="client-stubhub">â€”</div>
      </div>
      <div class="client-card" data-client="tiktok_rss" onclick="filterByClient('tiktok_rss')">
        <div class="client-card-name">TikTok</div>
        <div class="client-card-count" id="client-tiktok">â€”</div>
      </div>
      <div class="client-card" data-client="us_soccer_foundation_rss" onclick="filterByClient('us_soccer_foundation_rss')">
        <div class="client-card-name">U.S. Soccer</div>
        <div class="client-card-count" id="client-ussoccer">â€”</div>
      </div>
      <div class="client-card" data-client="waymo_rss" onclick="filterByClient('waymo_rss')">
        <div class="client-card-name">Waymo</div>
        <div class="client-card-count" id="client-waymo">â€”</div>
      </div>
    </div>
  </div>

  <!-- Category Cards (Centered Below) -->
  <div class="category-cards-section">
    <div class="category-cards-container">
      <div class="category-card" data-filter="top_news" onclick="filterByEntity('top_news')">
        <div class="category-card-name">Top News</div>
        <div class="category-card-count" id="sb-top-news">â€”</div>
      </div>
      <div class="category-card" data-filter="newsletters" onclick="filterByEntity('newsletters')">
        <div class="category-card-name">Newsletters</div>
        <div class="category-card-count" id="sb-newsletters">â€”</div>
      </div>
    </div>
  </div>

  <div class="wrap">
    <!-- AI Chat Interface -->
    <div class="chat-container">
      <div class="chat-header">
        AI Assistant
        <span style="font-size:12px;font-weight:400;color:#666;margin-left:auto">Powered by OpenAI</span>
      </div>
      <textarea
        id="chat-input"
        class="chat-input"
        placeholder="Ask questions, paste full article for client summary, or click 'Summarize Articles'..."
      ></textarea>
      <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap">
        <button id="chat-button" class="chat-button" onclick="askAI()" style="flex:1;min-width:150px">Ask AI</button>
        <button id="summarize-button" class="chat-button" onclick="summarizeWeekly()" style="flex:1;background:#5a7c50;min-width:150px">Summarize Articles</button>
        <button id="summarize-selected-button" class="chat-button" onclick="summarizeSelected()" style="flex:1;background:#8b7c50;min-width:150px;display:none" title="Summarize selected articles">Summarize Selected (<span id="selected-count">0</span>)</button>
        <button id="client-summary-button" class="chat-button" onclick="generateClientSummary()" style="flex:1;background:#6b8e5f;min-width:150px">Digest Summary</button>
        <button id="clear-chat-button" class="chat-button" onclick="clearChat()" style="background:#999;min-width:120px" title="Clear the chat history">Clear Chat</button>
      </div>

      <div id="chat-loading" class="chat-loading">
        <span>Analyzing articles...</span>
      </div>
      <div id="chat-response" class="chat-response"></div>

      <!-- Save to Client Summaries Button (hidden by default) -->
      <div id="save-summary-section" style="display:none;margin-top:12px">
        <button onclick="saveToClientSummaries()" class="chat-button" style="background:#4a6741;width:100%">
          Save to Digest Summaries Page
        </button>
      </div>
    </div>

    <!-- Filter Bar -->
    <div class="filter-bar">
      <div class="filter-section">
        <label for="search" style="font-size:13px;font-weight:600;color:#666">Search</label>
        <input id="search" placeholder="Filter titleâ€¦" style="min-width:200px"/>
      </div>

      <div class="filter-divider"></div>

      <div class="filter-section">
        <label style="font-size:13px;font-weight:600;color:#666">Date Range</label>
        <div style="display:flex;gap:8px;align-items:center">
          <button class="date-preset-btn" onclick="setDatePreset('today')">Today</button>
          <button class="date-preset-btn active" onclick="setDatePreset('7days')">Last 7 Days</button>
          <button class="date-preset-btn" onclick="setDatePreset('14days')">Last 14 Days</button>
          <button class="date-preset-btn" onclick="setDatePreset('all')">All</button>
          <input type="date" id="date-from" onchange="setCustomDateRange()" style="width:140px"/>
          <span style="color:#666">to</span>
          <input type="date" id="date-to" onchange="setCustomDateRange()" style="width:140px"/>
        </div>
      </div>

      <div class="filter-divider"></div>

      <div class="filter-section">
        <label for="feed-filter" style="font-weight:600;font-size:14px;color:#333">Filter by Feed:</label>
        <select id="feed-filter" class="filter-input" onchange="filterByFeed(this.value)" style="min-width:250px">
          <option value="all">All Feeds</option>
          <optgroup label="General News" id="feed-general"></optgroup>
          <optgroup label="Local News" id="feed-local"></optgroup>
          <optgroup label="Client Feeds" id="feed-clients"></optgroup>
        </select>
      </div>

      <div class="filter-divider"></div>

      <div class="filter-section" style="margin-left:auto">
        <button id="refresh-news-btn" class="action-btn">
          <span id="refresh-btn-text">Get Latest News</span>
        </button>
      </div>
    </div>

    <div id="err"></div>
    <h2 class="section-title">Recent Mentions</h2>
    <div id="loading" class="loading" style="display:none">Loading mentions...</div>
    <div id="list" class="articles-container"></div>
  </div>

  <script>
    // XSS Protection: Escape HTML in user-generated content
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    let loadingSkeletons = [];

    function createLoadingSkeleton(){
      const div=document.createElement('div');
      div.className='card-loading';
      div.innerHTML=`
        <div class="skeleton skeleton-title"></div>
        <div class="skeleton skeleton-meta"></div>
        <div class="skeleton skeleton-meta" style="width:30%"></div>
        <div style="margin-top:16px">
          <div class="skeleton skeleton-chip"></div>
          <div class="skeleton skeleton-chip"></div>
          <div class="skeleton skeleton-chip"></div>
        </div>`;
      return div;
    }
    function showLoadingSkeletons(count=5){
      const list=document.getElementById('list');
      list.innerHTML=''; loadingSkeletons=[];
      for (let i=0;i<count;i++){
        const s=createLoadingSkeleton(); s.style.animationDelay=`${i*0.1}s`;
        list.appendChild(s); loadingSkeletons.push(s);
      }
    }
    function removeLoadingSkeletons(){
      loadingSkeletons.forEach(s=>s.parentNode&&s.parentNode.removeChild(s));
      loadingSkeletons=[];
    }

    // Story deduplication functions
    function extractKeywords(text) {
      if (!text) return new Set();

      // Common words to ignore
      const stopWords = new Set([
        'a', 'an', 'and', 'are', 'as', 'at', 'be', 'by', 'for', 'from', 'has', 'he',
        'in', 'is', 'it', 'its', 'of', 'on', 'that', 'the', 'to', 'was', 'will',
        'with', 's', 'says', 'said', 'new', 'after', 'over', 'more', 'up', 'out',
        'about', 'who', 'get', 'which', 'their', 'have', 'had', 'not', 'but', 'his', 'her'
      ]);

      // Extract words, normalize, and filter
      const words = text.toLowerCase()
        .replace(/[^\w\s]/g, ' ') // Remove punctuation
        .split(/\s+/)
        .filter(w => w.length > 2 && !stopWords.has(w));

      return new Set(words);
    }

    function calculateSimilarity(article1, article2) {
      // Get text for comparison
      const text1 = `${article1.title || ''} ${getSummaryText(article1)}`;
      const text2 = `${article2.title || ''} ${getSummaryText(article2)}`;

      const keywords1 = extractKeywords(text1);
      const keywords2 = extractKeywords(text2);

      if (keywords1.size === 0 || keywords2.size === 0) return 0;

      // Calculate Jaccard similarity (intersection / union)
      const intersection = new Set([...keywords1].filter(w => keywords2.has(w)));
      const union = new Set([...keywords1, ...keywords2]);

      return intersection.size / union.size;
    }

    function getSummaryText(article) {
      if (!article.summary) return '';
      if (typeof article.summary === 'string') return article.summary;
      if (typeof article.summary === 'object') {
        return article.summary.opening_text ||
               article.summary.byline ||
               article.summary.content ||
               article.summary.description || '';
      }
      return '';
    }

    function isPrioritySource(origin) {
      const prioritySources = [
        'nyt_top_news_rss',
        'wapo_national_news_rss',
        'wapo_politics_rss',
        'politico_rss',
        'wapo_local_rss'
      ];
      return prioritySources.includes((origin || '').toLowerCase());
    }

    function deduplicateStories(articles) {
      if (!articles || articles.length === 0) return articles;

      const SIMILARITY_THRESHOLD = 0.3; // 30% keyword overlap = same story
      const groups = [];
      const processed = new Set();
      const duplicatesFound = [];

      // Group similar articles
      for (let i = 0; i < articles.length; i++) {
        if (processed.has(i)) continue;

        const group = [i];
        processed.add(i);

        // Find similar articles
        for (let j = i + 1; j < articles.length; j++) {
          if (processed.has(j)) continue;

          const similarity = calculateSimilarity(articles[i], articles[j]);
          if (similarity >= SIMILARITY_THRESHOLD) {
            group.push(j);
            processed.add(j);
          }
        }

        groups.push(group);
      }

      // For each group, select the best article
      const selectedArticles = [];

      for (const group of groups) {
        if (group.length === 1) {
          // No duplicates, keep the article
          selectedArticles.push(articles[group[0]]);
          continue;
        }

        // Multiple similar articles - select the best one
        const groupArticles = group.map(idx => articles[idx]);

        // First, try to find WaPo or NYT or POLITICO article
        const priorityArticle = groupArticles.find(a => isPrioritySource(a.origin));

        if (priorityArticle) {
          selectedArticles.push(priorityArticle);
          // Log which duplicates were removed
          const removed = groupArticles.filter(a => a !== priorityArticle);
          removed.forEach(a => {
            duplicatesFound.push({
              kept: priorityArticle.title.substring(0, 60),
              removed: a.title.substring(0, 60),
              keptSource: priorityArticle.source || priorityArticle.origin,
              removedSource: a.source || a.origin
            });
          });
        } else {
          // No priority source, keep the earliest published
          groupArticles.sort((a, b) => new Date(a.published) - new Date(b.published));
          selectedArticles.push(groupArticles[0]);
          // Log which duplicates were removed
          const removed = groupArticles.slice(1);
          removed.forEach(a => {
            duplicatesFound.push({
              kept: groupArticles[0].title.substring(0, 60),
              removed: a.title.substring(0, 60),
              keptSource: groupArticles[0].source || groupArticles[0].origin,
              removedSource: a.source || a.origin
            });
          });
        }
      }

      console.log(`[Deduplication] ${articles.length} articles â†’ ${selectedArticles.length} unique stories (removed ${duplicatesFound.length} duplicates)`);
      if (duplicatesFound.length > 0) {
        console.log('[Deduplication] Removed duplicates:', duplicatesFound);
      }

      return selectedArticles;
    }

    function formatDate(s){
      const d=new Date(s);
      return d.toLocaleString('en-US',{year:'numeric',month:'numeric',day:'numeric',hour:'numeric',minute:'2-digit',hour12:true});
    }

    function addArticleCard(container, article, delay=0){
      return new Promise(resolve=>{
        setTimeout(()=>{
          const div=document.createElement('div');
          div.className='card';
          div.style.animationDelay=`${delay}s`;
          // Handle both string summaries (RSS) and object summaries (Meltwater)
          let summaryText = '';
          if (article.summary) {
            if (typeof article.summary === 'string') {
              summaryText = article.summary;
            } else if (typeof article.summary === 'object') {
              // For Meltwater object summaries, try different fields
              summaryText = article.summary.opening_text ||
                           article.summary.byline ||
                           article.summary.content ||
                           article.summary.description ||
                           ''; // Don't fallback to JSON.stringify
            }
          }
          const summary = summaryText ? `<div class="article-summary"></div>` : '';

          // Check if article is selected for summary
          const isSelected = selectedArticles.has(article.id);

          // Format client name from origin
          const formatClientName = (origin) => {
            if (!origin) return '';
            // Remove _rss suffix and convert underscores to spaces, then title case
            let displayName = origin
              .replace(/_rss$/, '')
              .replace(/_/g, ' ')
              .replace(/\b\w/g, c => c.toUpperCase());

            // Special capitalization for NYT and WaPo
            displayName = displayName.replace(/\bNyt\b/g, 'NYT');
            displayName = displayName.replace(/\bWapo\b/g, 'WaPo');

            return displayName;
          };

          // Determine if this is a client feed
          const topNewsOrigins = ['nyt_top_news_rss', 'wapo_national_news_rss', 'wapo_politics_rss', 'politico_rss'];
          const localNewsOrigins = ['wapo_local_rss'];
          const origin = (article.origin || "").toLowerCase();
          const isClientFeed = !topNewsOrigins.includes(origin) && !localNewsOrigins.includes(origin) && origin;
          const clientName = isClientFeed ? formatClientName(article.origin) : '';

          // Check if article has a valid link
          const hasValidLink = article.link && article.link.startsWith('http');

          // Create card structure - only make title clickable if there's a valid link
          div.innerHTML=`
            <div class="card-content">
              <div style="display:flex;align-items:flex-start;margin-bottom:10px">
                <input type="checkbox"
                       class="flag-checkbox"
                       data-article-id="${article.id}"
                       data-article-title="${article.title.replace(/"/g, '&quot;')}"
                       data-article-link="${article.link || ''}"
                       data-article-source="${article.source}"
                       ${isSelected ? 'checked' : ''}>
                <h3 class="card-title" style="flex:1;margin:0">${hasValidLink ? `<a href="${article.link}" target="_blank" rel="noopener"></a>` : '<span class="no-link"></span>'}</h3>
              </div>
              <div class="meta">
                <div>${article.source || article.provider || 'Newsletter'} Â· ${formatDate(article.published)}${clientName ? ` Â· <strong style="color:#4a6741">${clientName}</strong>` : ''}</div>
              </div>
              ${summary}
            </div>`;

          // Safely set title and summary using textContent to decode HTML entities and strip tags
          const titleElement = div.querySelector('.card-title a') || div.querySelector('.card-title .no-link');
          if (titleElement) {
            // Use DOMParser to strip HTML tags and decode entities
            const parser = new DOMParser();
            const doc = parser.parseFromString(article.title, 'text/html');
            titleElement.textContent = doc.body.textContent || article.title;
          }

          if (summaryText) {
            const summaryDiv = div.querySelector('.article-summary');
            if (summaryDiv) {
              // Use DOMParser to strip HTML tags and decode entities
              const parser = new DOMParser();
              const doc = parser.parseFromString(summaryText, 'text/html');
              summaryDiv.textContent = doc.body.textContent || summaryText;
            }
          }

          // Add event listener to checkbox after it's added to DOM
          const checkbox = div.querySelector('.flag-checkbox');
          checkbox.addEventListener('click', function() {
            toggleSelection(this.dataset.articleId, this);
          });
          container.appendChild(div);
          resolve();
        }, delay*100);
      });
    }

    let currentFilter = 'all';
    let currentClientFilter = null; // For filtering by specific client
    let allMentions = [];
    let selectedArticles = new Set(); // Track selected articles for summary
    let allArticles = []; // Store all articles for summary
    let currentDatePreset = '7days'; // Default to last 7 days
    let customDateFrom = null;
    let customDateTo = null;

    // Set date range preset
    function setDatePreset(preset) {
      currentDatePreset = preset;
      customDateFrom = null;
      customDateTo = null;

      // Clear custom date inputs
      document.getElementById('date-from').value = '';
      document.getElementById('date-to').value = '';

      // Update button states
      document.querySelectorAll('.date-preset-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      event.target.classList.add('active');

      // Update date range label
      updateDateRangeLabel();

      // Reload mentions with new date filter
      loadMentions();
    }

    // Set custom date range
    function setCustomDateRange() {
      const fromInput = document.getElementById('date-from').value;
      const toInput = document.getElementById('date-to').value;

      if (fromInput && toInput) {
        customDateFrom = new Date(fromInput).getTime();
        customDateTo = new Date(toInput).setHours(23, 59, 59, 999); // End of day
        currentDatePreset = 'custom';

        // Deactivate preset buttons
        document.querySelectorAll('.date-preset-btn').forEach(btn => {
          btn.classList.remove('active');
        });

        // Update date range label
        updateDateRangeLabel();

        // Reload mentions with custom date range
        loadMentions();
      }
    }

    // Update the date range label above the cards
    function updateDateRangeLabel() {
      const label = document.getElementById('date-range-label');
      if (!label) return;

      switch(currentDatePreset) {
        case 'today':
          label.textContent = 'Today';
          break;
        case '7days':
          label.textContent = 'Last 7 Days';
          break;
        case '14days':
          label.textContent = 'Last 14 Days';
          break;
        case 'all':
          label.textContent = 'All Time';
          break;
        case 'custom':
          if (customDateFrom && customDateTo) {
            const fromDate = new Date(customDateFrom).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            const toDate = new Date(customDateTo).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            label.textContent = `${fromDate} - ${toDate}`;
          }
          break;
        default:
          label.textContent = 'Last 7 Days';
      }
    }

    // Get date range based on current preset or custom range
    function getDateRange() {
      const now = Date.now();

      if (customDateFrom && customDateTo) {
        return { from: customDateFrom, to: customDateTo };
      }

      switch(currentDatePreset) {
        case 'today':
          const startOfToday = new Date();
          startOfToday.setHours(0, 0, 0, 0);
          return { from: startOfToday.getTime(), to: now };
        case '7days':
          return { from: now - (7 * 24 * 60 * 60 * 1000), to: now };
        case '14days':
          return { from: now - (14 * 24 * 60 * 60 * 1000), to: now };
        case 'all':
          return { from: 0, to: now };
        default:
          return { from: now - (24 * 60 * 60 * 1000), to: now };
      }
    }

    async function loadMentions(){
      try{
        document.getElementById('err').style.display='none';
        showLoadingSkeletons(5);

        const search=(document.getElementById('search').value||'').trim().toLowerCase();

        const qs=new URLSearchParams();
        qs.set('limit','300');

        const r = await fetch('/api/get_mentions?limit=300', { cache: 'no-store' });
        if (!r.ok) throw new Error('HTTP '+r.status);
        const data=await r.json();

        // Store all mentions for filtering
        allMentions = Array.isArray(data) ? data : [];

        // Populate feed dropdown with available feeds
        populateFeedDropdown();

        // Apply current filter
        let filtered = allMentions;

        // Filter by selected date range
        const dateRange = getDateRange();
        filtered = filtered.filter(m => {
          const ts = new Date(m.published).getTime();
          return ts >= dateRange.from && ts <= dateRange.to;
        });

        // Apply entity/category filter
        if (currentFilter === 'top_news') {
          const topNewsOrigins = ['nyt_top_news_rss', 'wapo_national_news_rss', 'wapo_politics_rss', 'politico_rss'];
          filtered = filtered.filter(m => topNewsOrigins.includes((m.origin || "").toLowerCase()));
        } else if (currentFilter === 'newsletters') {
          const newsletterOrigins = ['newsletter'];
          filtered = filtered.filter(m => newsletterOrigins.includes((m.origin || "").toLowerCase()));
        } else if (currentFilter === 'clients') {
          // Filter for client feeds (everything except top news and newsletters)
          const topNewsOrigins = ['nyt_top_news_rss', 'wapo_national_news_rss', 'wapo_politics_rss', 'politico_rss'];
          const newsletterOrigins = ['newsletter'];
          const allGeneralNews = [...topNewsOrigins, ...newsletterOrigins];
          filtered = filtered.filter(m => !allGeneralNews.includes((m.origin || "").toLowerCase()));

          // If a specific client is selected, filter further
          if (currentClientFilter) {
            filtered = filtered.filter(m => {
              const origin = (m.origin || "").toLowerCase();
              // US Soccer includes both foundation and Cindy Parlow Cone feeds
              if (currentClientFilter.toLowerCase() === 'us_soccer_foundation_rss') {
                return origin === 'us_soccer_foundation_rss' || origin === 'cindy_parlow_cone_rss';
              }
              return origin === currentClientFilter.toLowerCase();
            });
          }
        } else if (currentFilter !== 'all') {
          // Handle RSS feed filter from dropdown
          filtered = filtered.filter(m => {
            let origin = (m.origin || "").toLowerCase();
            return origin === currentFilter;
          });
        }

        // Apply search filter
        if (search) filtered = filtered.filter(m => (m.title||"").toLowerCase().includes(search));

        // Sort: Congress first, then by date (newest first)
        filtered.sort((a, b) => {
          const aIsCongress = (a.origin || '').toLowerCase() === 'congress';
          const bIsCongress = (b.origin || '').toLowerCase() === 'congress';

          if (aIsCongress && !bIsCongress) return -1;  // a (Congress) comes first
          if (!aIsCongress && bIsCongress) return 1;   // b (Congress) comes first

          // Both same type - sort by date (newest first)
          return new Date(b.published) - new Date(a.published);
        });

        // Deduplicate similar stories
        filtered = deduplicateStories(filtered);

        removeLoadingSkeletons();

        const list=document.getElementById('list');
        list.innerHTML='';

        if (!filtered.length){
          list.innerHTML=`
            <div class="empty-state">
              <div class="empty-state-icon"></div>
              <h3>No mentions for this view</h3>
              <p>Try searching for a different term or refresh.</p>
              <button class="action-btn" onclick="loadMentions()">Refresh Data</button>
            </div>`;
          return;
        }

        for (let i=0;i<filtered.length;i++){
          await addArticleCard(list, filtered[i], i*0.05);
        }
      }catch(e){
        removeLoadingSkeletons();
        const el=document.getElementById('err'); el.style.display='block';
        el.textContent='Could not load mentions. '+e.message;
        console.error('Error loading mentions:', e);
      }
    }

    function filterByEntity(entity){
      currentFilter = entity;
      currentClientFilter = null; // Clear client filter when using entity filter

      // Update active state on category cards
      document.querySelectorAll('.category-card').forEach(item => {
        item.classList.remove('active');
      });
      const categoryCard = document.querySelector(`.category-card[data-filter="${entity}"]`);
      if (categoryCard) categoryCard.classList.add('active');

      // Clear client card active states
      document.querySelectorAll('.client-card').forEach(card => {
        card.classList.remove('active');
      });

      // Reload with filter
      loadMentions();
    }

    function filterByClient(clientOrigin){
      currentClientFilter = clientOrigin;
      currentFilter = 'clients'; // Set to clients category

      // Update active state on client cards
      document.querySelectorAll('.client-card').forEach(card => {
        card.classList.remove('active');
      });
      const activeCard = document.querySelector(`[data-client="${clientOrigin}"]`);
      if (activeCard) activeCard.classList.add('active');

      // Clear category card active states
      document.querySelectorAll('.category-card').forEach(card => {
        card.classList.remove('active');
      });

      // Reload with filter
      loadMentions();
    }

    document.getElementById('search').addEventListener('input', ()=>{
      clearTimeout(window._t); window._t=setTimeout(loadMentions,250);
    });

    document.getElementById('refresh-news-btn').addEventListener('click', async () => {
      const btn = document.getElementById('refresh-news-btn');
      const btnText = document.getElementById('refresh-btn-text');
      btn.disabled = true; btn.classList.add('loading'); btnText.textContent = 'Collecting fresh articles...';

      try {
        // Trigger RSS collection from all sources
        const collectionPromises = [
          fetch('/api/collect', { method: 'GET', cache: 'no-store' }).catch(e => {
            console.error('RSS collection error:', e);
            return { ok: false, error: e.message };
          }),
          fetch('/api/meltwater_collect', { method: 'GET', cache: 'no-store' }).catch(e => {
            console.error('Meltwater collection error:', e);
            return { ok: false, error: e.message };
          })
        ];

        btnText.textContent = 'Fetching articles...';
        await Promise.all(collectionPromises);

        // Now reload the dashboard with fresh data
        btnText.textContent = 'Loading dashboard...';
        await loadMentions();

        // Refresh stats and timestamp
        await Promise.all([refreshStats(), refreshTimestamp()]);

        btnText.textContent = 'Updated!';
        setTimeout(() => { btnText.textContent = 'Get Latest News'; }, 2000);
      } catch (error) {
        console.error('Refresh error:', error);
        btnText.textContent = 'Error - Try Again';
        setTimeout(() => { btnText.textContent = 'Get Latest News'; }, 3000);
      } finally {
        btn.disabled = false; btn.classList.remove('loading');
      }
    });

    // Refresh stats cards - counts articles by origin
    function refreshStats() {
      console.log('ðŸ“Š refreshStats called, allMentions length:', allMentions.length);

      if (!allMentions || allMentions.length === 0) {
        console.log('ðŸ“Š No mentions loaded yet');
        return;
      }

      // Filter by selected date range
      const dateRange = getDateRange();
      const filtered = allMentions.filter(m => {
        const ts = new Date(m.published).getTime();
        return ts >= dateRange.from && ts <= dateRange.to;
      });

      console.log('ðŸ“Š Filtered:', filtered.length, 'of', allMentions.length);

      // Count by origin
      const counts = {};
      filtered.forEach(m => {
        const origin = (m.origin || 'unknown').toLowerCase();
        counts[origin] = (counts[origin] || 0) + 1;
      });
      console.log('ðŸ“Š Counts by origin:', counts);

      // Update client cards
      document.getElementById('client-waymo').textContent = counts['waymo_rss'] || 0;
      document.getElementById('client-delta').textContent = counts['delta_air_lines_rss'] || 0;
      document.getElementById('client-google').textContent = counts['google_rss'] || 0;
      document.getElementById('client-stubhub').textContent = counts['stubhub_rss'] || 0;
      document.getElementById('client-tiktok').textContent = counts['tiktok_rss'] || 0;
      document.getElementById('client-ussoccer').textContent = (counts['us_soccer_foundation_rss'] || 0) + (counts['cindy_parlow_cone_rss'] || 0);

      // Update category cards
      const topNewsCount = (counts['nyt_top_news_rss'] || 0) + (counts['wapo_national_news_rss'] || 0) +
                          (counts['wapo_politics_rss'] || 0) + (counts['politico_rss'] || 0);
      document.getElementById('sb-top-news').textContent = topNewsCount;
      document.getElementById('sb-newsletters').textContent = counts['newsletter'] || 0;

      console.log('ðŸ“Š Stats updated');
    }

    // Refresh timestamp
    async function refreshTimestamp() {
      try {
        const res = await fetch('/api/get_mentions?limit=1', { cache: 'no-store' });
        if (!res.ok) throw new Error('HTTP '+res.status);
        const data = await res.json();

        if (Array.isArray(data) && data.length > 0) {
          const mostRecent = data[0];
          const timestamp = new Date(mostRecent.published);

          const etTime = timestamp.toLocaleString('en-US', {
            timeZone: 'America/New_York',
            hour: 'numeric',
            minute: '2-digit',
            hour12: true
          });

          const el = document.getElementById('header-last-updated');
          if (el) el.textContent = `${etTime} ET`;
        }
      } catch(e) {
        console.error('Error refreshing timestamp:', e);
      }
    }

    // AI Chat function
    async function askAI() {
      const input = document.getElementById('chat-input');
      const button = document.getElementById('chat-button');
      const summarizeButton = document.getElementById('summarize-button');
      const loading = document.getElementById('chat-loading');
      const response = document.getElementById('chat-response');
      const question = input.value.trim();

      if (!question) {
        alert('Please enter a question first');
        return;
      }

      // Show loading state
      button.disabled = true;
      summarizeButton.disabled = true;
      loading.style.display = 'flex';
      response.style.display = 'none';

      try {
        const res = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ question })
        });

        if (!res.ok) {
          throw new Error(`HTTP ${res.status}`);
        }

        const data = await res.json();

        if (data.ok) {
          const formattedAnswer = renderWithCitations(data.answer, data.sources);
          response.innerHTML = `<strong>Answer:</strong><br/><br/>${formattedAnswer}<br/><br/><small>Analyzed ${data.articles_analyzed} articles</small>`;
          response.style.display = 'block';
        } else {
          throw new Error(data.error || 'Unknown error');
        }
      } catch (error) {
        response.innerHTML = `<strong>Error:</strong> ${error.message}`;
        response.style.display = 'block';
      } finally {
        button.disabled = false;
        summarizeButton.disabled = false;
        loading.style.display = 'none';
      }
    }

    // Clear chat function
    function clearChat() {
      const input = document.getElementById('chat-input');
      const response = document.getElementById('chat-response');
      const saveSection = document.getElementById('save-summary-section');

      input.value = '';
      response.style.display = 'none';
      response.innerHTML = '';
      saveSection.style.display = 'none';
      currentClientSummary = null;
      currentClientTitle = null;
    }

    // Simple markdown to HTML converter
    function markdownToHtml(text) {
      if (!text) return '';

      // Escape dangerous HTML first
      let html = text.replace(/</g, '&lt;').replace(/>/g, '&gt;');

      // Convert markdown to HTML
      // Headers: ## Header -> <h3>Header</h3>
      html = html.replace(/^## (.+)$/gm, '<h3 style="font-size:16px;font-weight:700;margin:12px 0 8px 0;color:#1a1a1a">$1</h3>');
      html = html.replace(/^### (.+)$/gm, '<h4 style="font-size:14px;font-weight:700;margin:10px 0 6px 0;color:#333">$1</h4>');
      html = html.replace(/^#### (.+)$/gm, '<strong style="display:block;margin:8px 0 4px 0">$1</strong>');

      // Bold: **text** or __text__ -> <strong>text</strong>
      html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
      html = html.replace(/__(.+?)__/g, '<strong>$1</strong>');

      // Bullet points: - text -> <li>text</li>
      html = html.replace(/^- (.+)$/gm, '<li style="margin-left:20px;margin-bottom:4px">$1</li>');

      // Line breaks - reduce white space
      html = html.replace(/\n\n+/g, '<br/>'); // Multiple newlines become single break
      html = html.replace(/\n/g, ' '); // Single newlines become spaces

      return html;
    }

    // Render citations and sources section
    function renderWithCitations(answer, sources) {
      if (!answer) return '';

      // Convert markdown to HTML
      let html = markdownToHtml(answer);

      // Find all citations actually used in the text
      const citationsUsed = new Set();
      const citationRegex = /\[(\d{1,3})\]/g;
      let match;
      while ((match = citationRegex.exec(answer)) !== null) {
        citationsUsed.add(parseInt(match[1]));
      }

      // Convert citations [1], [2], [3] to clickable links
      // Match [1] through [999] - covers realistic citation counts
      html = html.replace(/\[(\d{1,3})\]/g, (match, num) => {
        return `<sup><a href="#source-${num}" style="color:#4a6741;text-decoration:none;font-weight:600">[${num}]</a></sup>`;
      });

      // Add sources section - ONLY for citations that were actually used
      if (sources && sources.length > 0 && citationsUsed.size > 0) {
        // Filter sources to only those that were cited
        const usedSources = sources.filter((source) => {
          const citationId = source.id || source.citation_id;
          return citationsUsed.has(citationId);
        });

        if (usedSources.length > 0) {
          html += '<br/><br/><hr style="border:none;border-top:1px solid rgba(139,195,74,.25);margin:16px 0"/>';
          html += '<strong style="font-size:15px">Sources:</strong><br/>';
          html += '<ol style="margin:8px 0;padding-left:20px;line-height:1.8">';

          usedSources.forEach((source) => {
            const citationId = source.id || source.citation_id; // Handle both formats
            const title = source.title || 'Untitled';
            const sourceText = source.source || 'Unknown source';
            const link = source.link || '#';

            html += `<li id="source-${citationId}" style="margin-bottom:8px">
              <a href="${link}" target="_blank" rel="noopener" style="color:#4a6741;text-decoration:underline">${title}</a>
              <span style="color:#666;font-size:12px"> - ${sourceText}</span>
            </li>`;
          });

          html += '</ol>';
        }
      }

      return html;
    }

    // Summarize Weekly Articles function
    async function summarizeWeekly() {
      const input = document.getElementById('chat-input');
      const button = document.getElementById('chat-button');
      const summarizeButton = document.getElementById('summarize-button');
      const clientSummaryButton = document.getElementById('client-summary-button');
      const loading = document.getElementById('chat-loading');
      const response = document.getElementById('chat-response');
      const saveSection = document.getElementById('save-summary-section');

      // Clear input and set default question
      input.value = '';
      saveSection.style.display = 'none';

      // Show loading state
      button.disabled = true;
      summarizeButton.disabled = true;
      clientSummaryButton.disabled = true;
      loading.style.display = 'flex';
      response.style.display = 'none';

      const today = new Date().toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
      const question = `Create an executive summary of today's Daily News Clips for The Messina Group. Format: Start with "Executive Summary: Daily News Clips - ${today}".

REQUIRED CLIENT SECTIONS (in this order):
1. **Waymo** - Summarize all Waymo articles (autonomous vehicles, regulatory, expansion)
2. **StubHub** - Summarize all StubHub articles (business news, fees, earnings, lawsuits)
3. **Delta Air Lines** - Summarize all Delta articles (corporate news, partnerships, major operational news)
4. **TikTok** - Summarize all TikTok articles (regulatory, legal, policy, corporate news)
5. **U.S. Soccer** - Summarize all U.S. Soccer Foundation and Cindy Parlow Cone articles (governance, leadership, policy)
6. **Google** - Summarize all Google articles (AI policy, antitrust, regulatory, major business news)
7. **Top News** - Summarize major political/national news (NYT, WashPost, Politico)
8. **Newsletters** - Summarize any newsletter articles

IMPORTANT RULES:
- Include EVERY client section even if there's only 1 article - do not skip clients
- If a client has no articles, write "No articles today" under that section
- For each client, provide a 2-4 sentence summary of key developments
- Use bullet points if multiple stories per client
- Cite sources with [1][2][3] notation
- Keep each client summary concise but complete
- Prioritize actionable intelligence for client calls and briefings

Total length: 500-700 words. Focus on what's immediately useful for The Messina Group team going into client calls.`;

      try {
        const res = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ question })
        });

        if (!res.ok) {
          throw new Error(`HTTP ${res.status}`);
        }

        const data = await res.json();

        if (data.ok) {
          // Convert markdown to HTML with citations
          const formattedAnswer = renderWithCitations(data.answer, data.sources);
          response.innerHTML = `<strong>Weekly Summary:</strong><br/><br/>${formattedAnswer}<br/><br/><small>Analyzed ${data.articles_analyzed} articles from the past 7 days</small>`;
          response.style.display = 'block';
        } else {
          throw new Error(data.error || 'Unknown error');
        }
      } catch (error) {
        response.innerHTML = `<strong>Error:</strong> ${error.message}`;
        response.style.display = 'block';
      } finally {
        button.disabled = false;
        summarizeButton.disabled = false;
        clientSummaryButton.disabled = false;
        loading.style.display = 'none';
      }
    }

    // Client Summary variables
    let currentClientSummary = null;
    let currentClientTitle = null;

    // Generate Client Summary
    async function generateClientSummary() {
      const articleText = document.getElementById('chat-input').value.trim();
      const button = document.getElementById('chat-button');
      const summarizeButton = document.getElementById('summarize-button');
      const clientSummaryButton = document.getElementById('client-summary-button');
      const loading = document.getElementById('chat-loading');
      const response = document.getElementById('chat-response');
      const saveSection = document.getElementById('save-summary-section');

      if (!articleText) {
        alert('Please paste the full article text (including headline) in the chat box above');
        return;
      }

      // Clear input
      document.getElementById('chat-input').value = '';

      // Show loading state
      button.disabled = true;
      summarizeButton.disabled = true;
      clientSummaryButton.disabled = true;
      loading.style.display = 'flex';
      response.style.display = 'none';
      saveSection.style.display = 'none';

      const prompt = `You are a professional news summarizer creating Daily News Clips for The Messina Group. Your task is to summarize news articles following these exact formatting and style guidelines:

FORMAT REQUIREMENTS:
- Start each summary with the headline in bold followed by the source in brackets: **Headline [Source]**
- Begin the summary text with >>> on a new line
- Keep summaries concise: 2-4 paragraphs maximum
- Include direct quotes when they add value or context
- Maintain a neutral, factual tone
- Focus on the most newsworthy elements: what happened, who was involved, key implications

CONTENT GUIDELINES:
- Lead with the most important information (inverted pyramid style)
- Include specific names, numbers, dates, and locations when relevant
- Attribute information properly (e.g., "according to court filings," "the official said")
- Explain why the story matters or what happens next when applicable
- Avoid editorializing or adding opinion

STYLE REQUIREMENTS:
- Write in clear, professional language
- Use active voice when possible
- Keep sentences concise and readable
- Avoid jargon unless necessary (and explain it if used)
- Maintain consistency in tone across all summaries

Please summarize the following article:
${articleText}`;

      try {
        const res = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ question: prompt })
        });

        if (!res.ok) {
          throw new Error(`HTTP ${res.status}`);
        }

        const data = await res.json();

        if (data.ok) {
          // Extract and format the response
          let formattedAnswer = data.answer;

          // Remove brackets around title if present
          formattedAnswer = formattedAnswer.replace(/^\[([^\]]+)\]/, '$1');

          // Split into lines
          const lines = formattedAnswer.split('\n').filter(line => line.trim());

          // First line should be the title
          const titleLine = lines[0].trim();

          // Find the summary part (starts with "Summary:")
          const summaryLines = lines.filter(line => line.includes('Summary:'));
          const otherLines = lines.filter(line => !line.includes('Summary:') && line !== titleLine);

          // Reconstruct: Title (bold) + Summary + other content
          const escapeForHtml = (str) => str.replace(/</g, '&lt;').replace(/>/g, '&gt;');
          let reconstructed = `<strong>${escapeForHtml(titleLine)}</strong>`;
          if (summaryLines.length > 0) {
            reconstructed += '<br/>' + summaryLines.map(l => escapeForHtml(l)).join('<br/>');
          }
          if (otherLines.length > 0) {
            reconstructed += '<br/>' + otherLines.map(l => escapeForHtml(l)).join('<br/>');
          }

          currentClientTitle = titleLine;
          currentClientSummary = formattedAnswer;

          response.innerHTML = `<strong>Client Summary:</strong><br/><br/>${reconstructed}`;
          response.style.display = 'block';
          saveSection.style.display = 'block';
        } else {
          throw new Error(data.error || 'Unknown error');
        }
      } catch (error) {
        response.innerHTML = `<strong>Error:</strong> ${error.message}`;
        response.style.display = 'block';
      } finally {
        button.disabled = false;
        summarizeButton.disabled = false;
        clientSummaryButton.disabled = false;
        loading.style.display = 'none';
      }
    }

    // Save to Client Summaries Page
    async function saveToClientSummaries() {
      if (!currentClientSummary || !currentClientTitle) {
        alert('No summary to save');
        return;
      }

      try {
        const res = await fetch('/api/client_summaries', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            title: currentClientTitle,
            summary: currentClientSummary,
            created_at: new Date().toISOString()
          })
        });

        if (!res.ok) {
          throw new Error(`HTTP ${res.status}`);
        }

        const data = await res.json();

        if (data.ok) {
          alert('Summary saved to Client Summaries page!');
          document.getElementById('save-summary-section').style.display = 'none';
        } else {
          throw new Error(data.error || 'Failed to save');
        }
      } catch (error) {
        alert(`Error saving summary: ${error.message}`);
      }
    }

    // Perplexity Search function
    async function searchPerplexity() {
      const button = document.getElementById('chat-button');
      const summarizeButton = document.getElementById('summarize-button');
      const clientSummaryButton = document.getElementById('client-summary-button');
      const perplexityButton = document.getElementById('perplexity-button');
      const loading = document.getElementById('chat-loading');
      const response = document.getElementById('chat-response');

      // Show loading state
      button.disabled = true;
      summarizeButton.disabled = true;
      clientSummaryButton.disabled = true;
      perplexityButton.disabled = true;
      loading.querySelector('span').textContent = 'Searching Perplexity for latest AI updates...';
      loading.style.display = 'flex';
      response.style.display = 'none';

      try {
        const res = await fetch('/api/perplexity_search', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });

        if (!res.ok) {
          throw new Error(`HTTP ${res.status}`);
        }

        const data = await res.json();

        if (data.ok) {
          const formattedAnswer = markdownToHtml(data.answer);

          // Format citations if available
          let citationsHtml = '';
          if (data.citations && data.citations.length > 0) {
            citationsHtml = '<br/><br/><strong>Sources:</strong><br/><ul style="margin:8px 0;padding-left:20px">';
            data.citations.forEach((citation, idx) => {
              citationsHtml += `<li style="margin-bottom:4px"><a href="${citation}" target="_blank" rel="noopener noreferrer" style="color:#4a6741;text-decoration:underline">${citation}</a></li>`;
            });
            citationsHtml += '</ul>';
          }

          response.innerHTML = `<strong>Perplexity Search Results:</strong><br/><br/>${formattedAnswer}${citationsHtml}`;
          response.style.display = 'block';
        } else {
          throw new Error(data.error || 'Unknown error');
        }
      } catch (error) {
        response.innerHTML = `<strong>Error:</strong> ${error.message}`;
        response.style.display = 'block';
      } finally {
        button.disabled = false;
        summarizeButton.disabled = false;
        clientSummaryButton.disabled = false;
        perplexityButton.disabled = false;
        loading.querySelector('span').textContent = 'Analyzing articles...';
        loading.style.display = 'none';
      }
    }

    // Article selection function for summary
    function toggleSelection(articleId, checkbox) {
      if (checkbox.checked) {
        selectedArticles.add(articleId);
      } else {
        selectedArticles.delete(articleId);
      }
      updateSelectedCount();
    }

    // Update selected articles count and button visibility
    function updateSelectedCount() {
      const countEl = document.getElementById('selected-count');
      const button = document.getElementById('summarize-selected-button');

      if (countEl) {
        countEl.textContent = selectedArticles.size;
      }

      if (button) {
        // Show button only if articles are selected
        button.style.display = selectedArticles.size > 0 ? 'flex' : 'none';
      }
    }

    // Summarize selected articles
    async function summarizeSelected() {
      if (selectedArticles.size === 0) {
        alert('Please select at least one article to summarize');
        return;
      }

      const button = document.getElementById('chat-button');
      const summarizeButton = document.getElementById('summarize-button');
      const summarizeSelectedButton = document.getElementById('summarize-selected-button');
      const clientSummaryButton = document.getElementById('client-summary-button');
      const perplexityButton = document.getElementById('perplexity-button');
      const loading = document.getElementById('chat-loading');
      const response = document.getElementById('chat-response');

      // Show loading state
      button.disabled = true;
      summarizeButton.disabled = true;
      summarizeSelectedButton.disabled = true;
      clientSummaryButton.disabled = true;
      perplexityButton.disabled = true;
      loading.querySelector('span').textContent = `Summarizing ${selectedArticles.size} selected articles...`;
      loading.style.display = 'flex';
      response.style.display = 'none';

      try {
        const articleIds = Array.from(selectedArticles);

        const res = await fetch('/api/summarize_selected', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ article_ids: articleIds })
        });

        if (!res.ok) {
          throw new Error(`HTTP ${res.status}`);
        }

        const data = await res.json();

        if (data.ok) {
          const formattedAnswer = renderWithCitations(data.answer, data.sources);
          response.innerHTML = `<strong>Summary of Selected Articles:</strong><br/><br/>${formattedAnswer}<br/><br/><small>Analyzed ${data.articles_analyzed} articles</small>`;
          response.style.display = 'block';
        } else {
          throw new Error(data.error || 'Unknown error');
        }
      } catch (error) {
        response.innerHTML = `<strong>Error:</strong> ${error.message}`;
        response.style.display = 'block';
      } finally {
        button.disabled = false;
        summarizeButton.disabled = false;
        summarizeSelectedButton.disabled = false;
        clientSummaryButton.disabled = false;
        perplexityButton.disabled = false;
        loading.querySelector('span').textContent = 'Analyzing articles...';
        loading.style.display = 'none';
      }
    }

    function populateFeedDropdown() {
      // Filter to last 24 hours
      const now = Date.now();
      const oneDayAgo = now - (24 * 60 * 60 * 1000);
      const last24h = allMentions.filter(m => {
        const ts = new Date(m.published).getTime();
        return ts >= oneDayAgo;
      });

      // Get unique origins
      const origins = [...new Set(last24h.map(m => (m.origin || "").toLowerCase()))];

      // Categorize feeds
      const generalNews = ['nyt_top_news_rss', 'wapo_national_news_rss', 'wapo_politics_rss', 'politico_rss'];
      const localNews = ['wapo_local_rss'];

      // Clear existing options
      document.getElementById('feed-general').innerHTML = '';
      document.getElementById('feed-local').innerHTML = '';
      document.getElementById('feed-clients').innerHTML = '';

      // Helper function to format display names
      function formatDisplayName(origin) {
        let displayName = origin.replace(/_rss$/, '').replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());

        // Special capitalization for NYT and WaPo
        displayName = displayName.replace(/\bNyt\b/g, 'NYT');
        displayName = displayName.replace(/\bWapo\b/g, 'WaPo');

        return displayName;
      }

      // Separate origins by category
      const generalOrigins = origins.filter(o => generalNews.includes(o));
      const localOrigins = origins.filter(o => localNews.includes(o));
      const clientOrigins = origins.filter(o => !generalNews.includes(o) && !localNews.includes(o));

      // Sort general news feeds alphabetically
      generalOrigins.sort((a, b) => {
        const nameA = formatDisplayName(a);
        const nameB = formatDisplayName(b);
        return nameA.localeCompare(nameB);
      });

      // Sort client feeds alphabetically
      clientOrigins.sort((a, b) => {
        const nameA = formatDisplayName(a);
        const nameB = formatDisplayName(b);
        return nameA.localeCompare(nameB);
      });

      // Populate general news dropdown (alphabetically sorted)
      generalOrigins.forEach(origin => {
        const displayName = formatDisplayName(origin);
        const option = `<option value="${origin}">${displayName}</option>`;
        document.getElementById('feed-general').innerHTML += option;
      });

      // Populate local news dropdown
      localOrigins.forEach(origin => {
        const displayName = formatDisplayName(origin);
        const option = `<option value="${origin}">${displayName}</option>`;
        document.getElementById('feed-local').innerHTML += option;
      });

      // Populate client feeds dropdown (alphabetically sorted)
      clientOrigins.forEach(origin => {
        const displayName = formatDisplayName(origin);
        const option = `<option value="${origin}">${displayName}</option>`;
        document.getElementById('feed-clients').innerHTML += option;
      });
    }

    function filterByFeed(feed) {
      currentFilter = feed;
      // Reset active state on category cards and client cards
      document.querySelectorAll('.category-card').forEach(item => {
        item.classList.remove('active');
      });
      document.querySelectorAll('.client-card').forEach(item => {
        item.classList.remove('active');
      });
      loadMentions();
    }

    // Load dashboard on page load
    async function initializeDashboard() {
      console.log('ðŸ”„ Dashboard initializing...');

      try {
        // Load existing data and show stats immediately
        console.log('ðŸ“Š Loading existing data...');
        await loadMentions();
        refreshStats();
        refreshTimestamp();
        console.log('âœ… Dashboard loaded');

        // Trigger RSS collection in background (non-blocking)
        fetch('/api/collect', { method: 'GET', cache: 'no-store' })
          .then(() => {
            console.log('âœ… RSS collection complete');
            loadMentions().then(() => {
              refreshStats();
            });
          })
          .catch(e => console.error('RSS collection error:', e));

      } catch (error) {
        console.error('âŒ Dashboard initialization error:', error);
        loadMentions();
        refreshStats();
        refreshTimestamp();
      }
    }

    // Initialize dashboard on page load
    initializeDashboard();
  </script>

<script>
/* Hide mock/test cards on the page only (no backend changes) */
(function(){
  const BAD_TITLE_PARTS = [
    'forced write test',
    'mw clamp test',
    'sanity write',
    'browser â†’ n8n test',
    'browser -> n8n test',
    'debug write'
  ];
  const BAD_SOURCES = ['example news','debug source'];
  const BAD_LINK_PARTS = ['example.com'];

  function isTestCard(card){
    const title = (card.querySelector('.card-title')?.innerText || '').toLowerCase().trim();
    const meta  = (card.querySelector('.meta')?.innerText || '').toLowerCase();
    const link  = (card.querySelector('.card-title a')?.href || '').toLowerCase();

    // title checks
    if (BAD_TITLE_PARTS.some(p => title.includes(p))) return true;

    // special: hide "Coinbase headline" only when the source is Example News
    if (title.includes('coinbase headline') && meta.includes('example news')) return true;

    // source / link checks
    if (BAD_SOURCES.some(s => meta.includes(s))) return true;
    if (BAD_LINK_PARTS.some(p => link.includes(p))) return true;

    return false;
  }

  function purge(){
    document.querySelectorAll('#list .card').forEach(card => {
      if (isTestCard(card)) card.remove();
    });
  }

  // Run now and whenever the list updates
  const list = document.getElementById('list');
  if (list){
    purge();
    new MutationObserver(purge).observe(list, { childList: true });
  } else {
    // Fallback: run shortly after load if #list is created later
    document.addEventListener('DOMContentLoaded', () => setTimeout(purge, 800));
  }
})();
</script>
  <script>
(async function(){
  // ---- Spikes (uses your existing #spike-section / #spike-container) ----
  try{
    const sec  = document.getElementById('spike-section');
    const grid = document.getElementById('spike-container');
    if (sec && grid){
      const r = await fetch('/api/spike_detection?window=today', { cache:'no-store' });
      const data = await r.json().catch(()=>({}));
      const spikes = Array.isArray(data?.spikes) ? data.spikes : [];
      if (!spikes.length){
        sec.style.display = 'none';
      }else{
        sec.style.display = '';
        grid.innerHTML = spikes.map(s => {
          const pct = (s.spike_percentage != null) ? `â†‘${s.spike_percentage}%` : '';
          const mentions = (s.mention_count ? s.mention_count.toLocaleString() + ' mentions â€¢ ' : '');
          const when = new Date(s.detected_at || Date.now()).toLocaleTimeString();
          const link = s.link ? `<div style="margin-top:6px;"><a target="_blank" rel="noreferrer" href="${s.link}" style="text-decoration:underline;">Open in Meltwater</a></div>` : '';
          return `
            <div class="spike-card">
              <div class="spike-hdr">
                <span class="spike-platform">${(s.platform||'SOCIAL').toUpperCase()}</span>
                <span class="spike-pct">${pct}</span>
              </div>
              <div class="spike-title">${s.title || '(untitled)'}</div>
              <p class="spike-meta">${mentions}${when}</p>
              ${link}
            </div>`;
        }).join('');
      }
    }
  }catch(e){ console.warn('spikes load error', e); }

  // ---- Sentiment (optional; requires Step 2 container) ----
  try{
    const sec  = document.getElementById('sent-section');
    const box  = document.getElementById('sent-container');
    if (sec && box){
      const r = await fetch('/api/sentiment_overview?window=today', { cache:'no-store' });
      const data = await r.json().catch(()=>({}));
      const s = data?.latest || null;
      if (!s){
        sec.style.display = 'none';
      }else{
        sec.style.display = '';
        const when = new Date(s.detected_at || Date.now()).toLocaleTimeString();
        const link = s.link ? `<div style="margin-top:6px;"><a target="_blank" rel="noreferrer" href="${s.link}" style="text-decoration:underline;">Details in Meltwater</a></div>` : '';
        box.innerHTML = `
          <div style="border:1px solid #90caf9;background:linear-gradient(135deg,#e1f5fe,#e3f2fd);border-radius:12px;padding:12px;">
            <div style="font-weight:600;margin-bottom:6px;">${s.title || 'Sentiment shift detected'}</div>
            <div style="font-size:12px;opacity:.7;">Direction: <b>${s.direction || 'â€”'}</b> â€¢ ${when}</div>
            ${link}
          </div>`;
      }
    }
  }catch(e){ console.warn('sentiment load error', e); }
})();
</script>
<script>
// Real-time streaming updates
(function() {
  let eventSource = null;
  let reconnectTimeout = null;
  let reconnectAttempts = 0;

  function connectToStream() {
    console.log('Connecting to real-time stream...');

    eventSource = new EventSource('/api/stream');

    eventSource.onopen = function() {
      console.log('Stream connected');
      reconnectAttempts = 0;
    };

    eventSource.onmessage = function(event) {
      try {
        const data = JSON.parse(event.data);
        handleStreamUpdate(data);
      } catch (error) {
        console.error('Error parsing stream data:', error);
      }
    };

    eventSource.onerror = function(error) {
      console.error('Stream error:', error);
      eventSource.close();

      // Exponential backoff for reconnection
      reconnectAttempts++;
      const delay = Math.min(1000 * Math.pow(2, reconnectAttempts), 30000);

      clearTimeout(reconnectTimeout);
      reconnectTimeout = setTimeout(() => {
        connectToStream();
      }, delay);
    };
  }

  function handleStreamUpdate(data) {
    console.log('Stream update:', data);

    if (data.type === 'new_mentions') {
      // New mentions received
      showNewMentionsNotification(data);

      // Add mentions to the top of the list
      if (data.mentions && data.mentions.length > 0) {
        addNewMentionsToList(data.mentions);
      }

      // Refresh counts
      // Removed Meltwater-specific count updates
    }
  }

  function showNewMentionsNotification(data) {
    // Create notification banner
    const notification = document.createElement('div');
    notification.className = 'stream-notification';
    notification.innerHTML = `
      <div style="background:linear-gradient(135deg,#4caf50,#8bc34a);color:white;padding:12px 20px;border-radius:8px;margin:16px auto;max-width:1200px;display:flex;align-items:center;justify-content:space-between;animation:slideDown 0.5s ease">
        <span>${data.count} new mention${data.count > 1 ? 's' : ''} received!</span>
        <button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:white;cursor:pointer;font-size:20px">Ã—</button>
      </div>
    `;

    // Insert at top of main content
    const wrap = document.querySelector('.wrap');
    if (wrap) {
      wrap.insertBefore(notification, wrap.firstChild);

      // Auto-remove after 5 seconds
      setTimeout(() => {
        notification.style.opacity = '0';
        setTimeout(() => notification.remove(), 300);
      }, 5000);
    }
  }

  function addNewMentionsToList(mentions) {
    const list = document.getElementById('list');
    if (!list) return;

    mentions.forEach((mention, index) => {
      // Check if mention already exists
      const existing = list.querySelector(`[data-mention-id="${mention.id}"]`);
      if (existing) return;

      // Create new card
      const div = document.createElement('div');
      div.className = 'card new-mention';
      div.setAttribute('data-mention-id', mention.id);
      div.style.cssText = 'animation:slideInNew 0.5s ease forwards;border:2px solid #4caf50';

      div.innerHTML = `
        <div class="card-content">
          <span style="position:absolute;top:10px;right:10px;background:#4caf50;color:white;padding:2px 8px;border-radius:4px;font-size:10px;font-weight:600">NEW</span>
          <h3 class="card-title"><a href="${mention.link}" target="_blank" rel="noopener"></a></h3>
          <div class="meta">
            <div><span class="source-name"></span> Â· Just now</div>
          </div>
        </div>
      `;

      // Safely set text content to decode HTML entities and strip tags
      const titleLink = div.querySelector('.card-title a');
      const sourceName = div.querySelector('.source-name');
      if (titleLink) {
        const parser = new DOMParser();
        const doc = parser.parseFromString(mention.title, 'text/html');
        titleLink.textContent = doc.body.textContent || mention.title;
      }
      if (sourceName) {
        const parser = new DOMParser();
        const doc = parser.parseFromString(mention.source, 'text/html');
        sourceName.textContent = doc.body.textContent || mention.source;
      }

      // Insert at the top of the list
      list.insertBefore(div, list.firstChild);

      // Remove "NEW" badge after 30 seconds
      setTimeout(() => {
        const badge = div.querySelector('span');
        if (badge) badge.style.display = 'none';
        div.style.border = '1px solid rgba(139,195,74,.12)';
      }, 30000);
    });
  }

  function animateCountUpdate(element, newValue) {
    const oldValue = parseInt(element.textContent) || 0;
    if (oldValue === newValue) return;

    // Highlight the element
    element.style.transition = 'all 0.3s';
    element.style.transform = 'scale(1.2)';
    element.style.color = '#4caf50';

    // Animate the number
    const duration = 1000;
    const start = Date.now();
    const diff = newValue - oldValue;

    function updateNumber() {
      const elapsed = Date.now() - start;
      const progress = Math.min(elapsed / duration, 1);
      const current = Math.floor(oldValue + diff * progress);

      element.textContent = current.toLocaleString();

      if (progress < 1) {
        requestAnimationFrame(updateNumber);
      } else {
        // Reset styling
        setTimeout(() => {
          element.style.transform = 'scale(1)';
          element.style.color = '#4a6741';
        }, 300);
      }
    }

    updateNumber();
  }


  // Add CSS for animations
  const style = document.createElement('style');
  style.textContent = `
    @keyframes slideDown {
      from {
        transform: translateY(-100%);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    @keyframes slideInNew {
      from {
        transform: translateX(-20px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    .stream-notification {
      position: fixed;
      top: 80px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 999;
      transition: opacity 0.3s;
    }

    .new-mention {
      position: relative;
    }
  `;
  document.head.appendChild(style);

  // Connect when page loads
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', connectToStream);
  } else {
    connectToStream();
  }

  // Cleanup on page unload
  window.addEventListener('beforeunload', () => {
    if (eventSource) {
      eventSource.close();
    }
  });
})();
</script>
</body>
</html>
